# ModelSharedIn

ModelSharedIn manages the OpenAPI‑driven dependencies of the Model project. It merges external OpenAPI documents (JSON) into a single schema and generates the C# DTOs and client classes consumed by `Model`.

- Inputs: `ModelSharedIn/json-schemas/*.json` (OpenAPI documents for upstream microservices, e.g., GeodeticDatum)
- Outputs: `ModelSharedIn/MergedModel.json` (merged OpenAPI) and `ModelSharedIn/MergedModel.cs` (generated C#)
- Namespace: `NORCE.Drilling.CartographicProjection.ModelShared`

## Purpose

- Centralize and version the external API schemas that `Model` depends on.
- Generate strongly‑typed DTOs and optional API clients from those schemas.
- Ensure `Model` builds without taking a direct runtime dependency on other services.

## How It Fits In

- `Model` (`Model/Model.csproj:1`) references `ModelSharedIn` to use types such as `GeodeticDatum`, `Spheroid`, and `GeodeticCoordinate`.
- `Service` references `Model` to expose HTTP endpoints; it does not reference `ModelSharedIn` directly.
- `ModelSharedOut` is a separate tool that generates shared models for clients of this microservice (used by `WebApp` and `ServiceTest`).

## Dependencies

Defined in `ModelSharedIn/ModelSharedIn.csproj:1`:
- `Microsoft.OpenApi.Readers`: Parses OpenAPI documents.
- `NSwag.CodeGeneration.CSharp`: Generates C# DTOs and clients (System.Text.Json).

## Generate The Shared Model

1) Place dependency schemas in `ModelSharedIn/json-schemas/` as `.json` files.
   - Example: `GeodeticDatumMergedModel.json` (already present).
2) Run the generator (from the solution root):

```bash
# build and run
dotnet run --project ModelSharedIn/ModelSharedIn.csproj
```

What happens:
- All `json-schemas/*.json` are read and merged (schema ids normalized to short names).
- `MergedModel.json` is written for inspection (OpenAPI 3.0.3 format).
- `MergedModel.cs` is generated with DTOs and client methods under `NORCE.Drilling.CartographicProjection.ModelShared`.

Notes:
- The tool searches upward for the `.sln` to locate the solution root and `ModelSharedIn` folder.
- If outputs already exist, you are prompted before overwriting.

## Usage Examples

Use the generated types from `Model` (or any project referencing `ModelSharedIn`). For instance, `Model/CartographicConversionSet.cs:1` expects `GeodeticDatum` and `Spheroid` from this namespace when building PROJ.4 strings.

Example — create a WGS84‑like spheroid and call `Model` conversion methods:

```csharp
using NORCE.Drilling.CartographicProjection.Model;
using NORCE.Drilling.CartographicProjection.ModelShared; // generated by ModelSharedIn

var datum = new GeodeticDatum
{
    Spheroid = new Spheroid
    {
        // Set either a/b or inverse flattening as your schema allows
        // SemiMajorAxis.DiracDistributionValue.Value.Value = 6378137.0;
        // InverseFlattening.DiracDistributionValue.Value.Value = 298.257223563;
    }
};

var proj = new CartographicProjection { ProjectionType = ProjectionType.UTM, Zone = 32, IsSouth = false };
var set = new CartographicConversionSet();

double lat = 60.0 * Math.PI / 180.0;
double lon = 5.0 * Math.PI / 180.0;
set.ToCarto(proj, datum, lat, lon, out var n, out var e);
```

Example — call a generated client (if present in the merged schema):

```csharp
using var http = new HttpClient();
var client = new Client("https://example-host/SomeDependency/api/", http);
var result = await client.GetAllGeodeticConversionSetIdAsync();
```

(Available client methods depend on what operations are included in the merged OpenAPI documents.)

## Updating Dependencies

- Add or replace `.json` files in `ModelSharedIn/json-schemas/` with updated OpenAPI documents from upstream services.
- Re‑run the generator to refresh `MergedModel.cs` and `MergedModel.json`.
- Commit the changes with your service updates to keep the shared model in sync.

## Implementation Details

- Main entry: `ModelSharedIn/Program.cs:1`
  - Merges OpenAPI paths and normalizes schema references via `OpenApiSchemaReferenceUpdater`.
  - Forces OpenAPI version to 3.0.3 for current Swagger tooling compatibility.
  - Generates C# DTOs/clients using NSwag with the configured namespace.
- Schema utilities: `ModelSharedIn/OpenApiSchemaReferenceUpdater.cs:1`
  - Deep‑clones schemas and updates `$ref` targets to the normalized short names.

